# Tools and Agent Actions

<details>
<summary>Relevant source files</summary>

The following files were used as context for generating this wiki page:

- [docs/en/tools/overview.mdx](https://github.com/crewAIInc/crewAI/blob/81bd81e5/docs/en/tools/overview.mdx)
- [src/crewai/agents/__init__.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/agents/__init__.py)
- [src/crewai/agents/agent_builder/base_agent_executor_mixin.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/agents/agent_builder/base_agent_executor_mixin.py)
- [src/crewai/agents/constants.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/agents/constants.py)
- [src/crewai/agents/parser.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/agents/parser.py)
- [src/crewai/agents/tools_handler.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/agents/tools_handler.py)
- [src/crewai/cli/crew_chat.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/cli/crew_chat.py)
- [src/crewai/tools/base_tool.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/tools/base_tool.py)
- [src/crewai/tools/structured_tool.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/tools/structured_tool.py)
- [src/crewai/utilities/agent_utils.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/utilities/agent_utils.py)
- [src/crewai/utilities/llm_utils.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/utilities/llm_utils.py)
- [tests/agents/test_crew_agent_parser.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/tests/agents/test_crew_agent_parser.py)
- [tests/cassettes/test_ensure_exchanged_messages_are_propagated_to_external_memory.yaml](https://github.com/crewAIInc/crewAI/blob/81bd81e5/tests/cassettes/test_ensure_exchanged_messages_are_propagated_to_external_memory.yaml)
- [tests/cassettes/test_get_knowledge_search_query.yaml](https://github.com/crewAIInc/crewAI/blob/81bd81e5/tests/cassettes/test_get_knowledge_search_query.yaml)
- [tests/cassettes/test_max_usage_count_is_respected.yaml](https://github.com/crewAIInc/crewAI/blob/81bd81e5/tests/cassettes/test_max_usage_count_is_respected.yaml)
- [tests/test_crew.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/tests/test_crew.py)
- [tests/test_task.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/tests/test_task.py)
- [tests/tools/test_base_tool.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/tests/tools/test_base_tool.py)
- [tests/tools/test_structured_tool.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/tests/tools/test_structured_tool.py)
- [tests/tools/test_tool_usage_limit.py](https://github.com/crewAIInc/crewAI/blob/81bd81e5/tests/tools/test_tool_usage_limit.py)

</details>



This document covers the tools system and agent actions in CrewAI, including tool definition, creation, execution, and integration with agents. Tools are the primary mechanism by which agents interact with external systems and perform specific actions. Agent actions represent the parsed instructions from LLMs that determine which tools to use and how.

For information about task execution and management, see [Task Management](#2.3). For details about agent execution patterns, see [Agent Execution](#2.2).

## Tool Architecture Overview

CrewAI's tool system is built around a hierarchical architecture that supports both simple function-based tools and complex structured tools with validation and usage tracking.

### Tool Creation and Inheritance Hierarchy

```mermaid
graph TB
    subgraph "Tool Creation"
        Decorator["@tool decorator"] --> Tool["Tool class"]
        BaseClass["BaseTool subclass"] --> Tool
        Function["from_function()"] --> CrewStructuredTool["CrewStructuredTool"]
        Tool --> CrewStructuredTool
    end
    
    subgraph "Base Classes"
        BaseTool["BaseTool (ABC)"]
        Tool --> BaseTool
        CrewStructuredTool --> BaseTool
    end
    
    subgraph "Core Components"
        BaseTool --> name["name: str"]
        BaseTool --> description["description: str"] 
        BaseTool --> args_schema["args_schema: Type[BaseModel]"]
        BaseTool --> _run["_run() method"]
        BaseTool --> max_usage_count["max_usage_count: int | None"]
        BaseTool --> result_as_answer["result_as_answer: bool"]
    end
    
    subgraph "Validation & Execution"
        CrewStructuredTool --> validate["_validate_function_signature()"]
        CrewStructuredTool --> parse_args["_parse_args()"]
        CrewStructuredTool --> invoke["invoke() / ainvoke()"]
    end
```

Sources: [src/crewai/tools/base_tool.py:25-330](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/tools/base_tool.py#L25-L330), [src/crewai/tools/structured_tool.py:21-303](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/tools/structured_tool.py#L21-L303)

### Tool Integration with Agent System

```mermaid
graph LR
    subgraph "Agent Layer"
        Agent["Agent"] --> tools_list["tools: List[BaseTool]"]
        Task["Task"] --> task_tools["tools: List[BaseTool]"]
    end
    
    subgraph "Tool Processing"
        tools_list --> parse_tools["parse_tools()"]
        task_tools --> parse_tools
        parse_tools --> structured_tools["List[CrewStructuredTool]"]
    end
    
    subgraph "Execution Layer"
        structured_tools --> ToolsHandler["ToolsHandler"]
        ToolsHandler --> CacheHandler["CacheHandler"]
        ToolsHandler --> last_used_tool["last_used_tool"]
    end
    
    subgraph "LLM Integration"
        structured_tools --> tool_descriptions["render_text_description_and_args()"]
        tool_descriptions --> llm_prompt["LLM System Prompt"]
    end
```

Sources: [src/crewai/utilities/agent_utils.py:29-60](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/utilities/agent_utils.py#L29-L60), [src/crewai/agents/tools_handler.py:8-45](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/agents/tools_handler.py#L8-L45)

## Tool Definition and Creation

### BaseTool Class Structure

The `BaseTool` class serves as the foundation for all tools in CrewAI. It defines the core interface and provides automatic schema generation.

Key properties defined in [src/crewai/tools/base_tool.py:25-51]():
- `name`: Unique tool identifier
- `description`: Instructions for LLM on when/how to use the tool
- `args_schema`: Pydantic model defining input parameters
- `max_usage_count`: Optional limit on tool usage
- `result_as_answer`: Whether tool output becomes the final agent answer
- `cache_function`: Function determining if results should be cached

### Tool Creation Methods

**Decorator-based Creation**
```python
@tool("tool_name", result_as_answer=False, max_usage_count=None)
def my_tool(param: str) -> str:
    """Tool description for the LLM."""
    return f"Result: {param}"
```

**Class-based Creation**
```python
class MyTool(BaseTool):
    name: str = "my_tool"
    description: str = "Tool description"
    
    def _run(self, param: str) -> str:
        return f"Result: {param}"
```

**Function-based Creation**
```python
tool = CrewStructuredTool.from_function(
    func=my_function,
    name="tool_name",
    description="Description"
)
```

Sources: [src/crewai/tools/base_tool.py:283-330](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/tools/base_tool.py#L283-L330), [src/crewai/tools/structured_tool.py:64-124](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/tools/structured_tool.py#L64-L124)

### Schema Generation and Validation

CrewAI automatically generates Pydantic schemas from function signatures. The schema generation process is handled in [src/crewai/tools/base_tool.py:52-69]() and [src/crewai/tools/structured_tool.py:125-164]().

```mermaid
graph TB
    subgraph "Schema Generation Flow"
        func_sig["Function Signature"] --> inspect["inspect.signature()"]
        inspect --> type_hints["get_type_hints()"]
        type_hints --> pydantic_fields["Pydantic Field Definitions"]
        pydantic_fields --> create_model["create_model()"]
        create_model --> args_schema["args_schema: Type[BaseModel]"]
    end
    
    subgraph "Validation Flow"
        tool_input["Raw Tool Input"] --> parse_args["_parse_args()"]
        parse_args --> json_loads["JSON parsing"]
        json_loads --> model_validate["args_schema.model_validate()"]
        model_validate --> validated_args["Validated Arguments"]
    end
    
    subgraph "Function Validation"
        args_schema --> validate_sig["_validate_function_signature()"]
        validate_sig --> param_check["Check required parameters"]
        param_check --> schema_match["Verify schema matches function"]
    end
```

Sources: [src/crewai/tools/structured_tool.py:165-190](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/tools/structured_tool.py#L165-L190), [src/crewai/tools/structured_tool.py:191-213](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/tools/structured_tool.py#L191-L213)

## Agent Actions and LLM Integration

### Action Types and Parsing

CrewAI uses a ReAct (Reasoning and Acting) format for agent actions. The system parses LLM outputs into structured action objects.

**Core Action Classes** defined in [src/crewai/agents/parser.py:26-44]():
- `AgentAction`: Represents a tool usage action
- `AgentFinish`: Represents the final answer

```mermaid
graph TB
    subgraph "LLM Output Parsing"
        llm_output["LLM Raw Output"] --> parse_func["parse()"]
        parse_func --> extract_thought["_extract_thought()"]
        parse_func --> check_final["Check for 'Final Answer:'"]
        parse_func --> action_regex["ACTION_INPUT_REGEX"]
    end
    
    subgraph "Action Creation"
        check_final -->|Yes| AgentFinish["AgentFinish(thought, output, text)"]
        action_regex -->|Match| clean_action["_clean_action()"]
        clean_action --> repair_json["_safe_repair_json()"]
        repair_json --> AgentAction["AgentAction(thought, tool, tool_input, text)"]
    end
    
    subgraph "Error Handling"
        action_regex -->|No Match| missing_action["MISSING_ACTION_AFTER_THOUGHT_ERROR"]
        missing_action --> OutputParserException["OutputParserException"]
        repair_json -->|Failed| return_original["Return original input"]
    end
```

Sources: [src/crewai/agents/parser.py:63-134](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/agents/parser.py#L63-L134), [src/crewai/agents/constants.py:8-27](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/agents/constants.py#L8-L27)

### Tool Execution Flow

The tool execution process involves multiple layers of validation, caching, and result handling.

```mermaid
graph TB
    subgraph "Agent Decision"
        llm_call["LLM Call"] --> parse_output["parse() -> AgentAction"]
        parse_output --> tool_name["Extract tool name"]
        parse_output --> tool_input["Extract tool_input"]
    end
    
    subgraph "Tool Resolution"
        tool_name --> find_tool["Find matching tool"]
        find_tool --> structured_tool["CrewStructuredTool instance"]
    end
    
    subgraph "Execution Pipeline"
        structured_tool --> check_usage["has_reached_max_usage_count()"]
        check_usage -->|No| parse_args["_parse_args()"]
        check_usage -->|Yes| ToolUsageLimitExceededError["ToolUsageLimitExceededError"]
        parse_args --> increment_usage["_increment_usage_count()"]
        increment_usage --> invoke["invoke() or ainvoke()"]
        invoke --> func_call["Execute _run() method"]
        func_call --> result["Tool Result"]
    end
    
    subgraph "Result Processing"
        result --> check_result_as_answer["Check result_as_answer"]
        check_result_as_answer -->|True| AgentFinish2["AgentFinish"]
        check_result_as_answer -->|False| update_action["Update AgentAction.result"]
        update_action --> observation["Add Observation to text"]
    end
```

Sources: [src/crewai/tools/structured_tool.py:258-280](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/tools/structured_tool.py#L258-L280), [src/crewai/utilities/agent_utils.py:187-223](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/utilities/agent_utils.py#L187-L223)

## Usage Management and Limits

### Usage Tracking System

Tools support usage limits to prevent excessive calls. The tracking system is implemented across both `BaseTool` and `CrewStructuredTool`.

**Usage Count Management** in [src/crewai/tools/base_tool.py:94-101]():
- `current_usage_count`: Tracks actual usage
- `max_usage_count`: Optional limit (None = unlimited)
- `reset_usage_count()`: Resets counter to zero

**Usage Limit Enforcement** in [src/crewai/tools/structured_tool.py:281-293]():
```python
def has_reached_max_usage_count(self) -> bool:
    return (
        self.max_usage_count is not None
        and self.current_usage_count >= self.max_usage_count
    )
```

### Cache Integration

The `ToolsHandler` class manages tool result caching through integration with `CacheHandler`.

```mermaid
graph LR
    subgraph "Cache Flow"
        tool_execution["Tool Execution"] --> tools_handler["ToolsHandler.on_tool_use()"]
        tools_handler --> should_cache["Check should_cache"]
        should_cache -->|True| cache_add["CacheHandler.add()"]
        should_cache -->|False| skip_cache["Skip caching"]
        cache_add --> cache_key["Generate cache key"]
        cache_key --> store_result["Store result"]
    end
    
    subgraph "Cache Key Generation"
        tool_name["calling.tool_name"] --> key_components["Key Components"]
        arguments["calling.arguments"] --> key_components
        key_components --> hash_key["MD5 Hash"]
    end
```

Sources: [src/crewai/agents/tools_handler.py:25-45](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/agents/tools_handler.py#L25-L45)

## Tool Integration Architecture

### Agent-Task-Tool Relationship

```mermaid
graph TB
    subgraph "Configuration Layer"
        agent_tools["Agent.tools"] --> tool_precedence["Tool Precedence Logic"]
        task_tools["Task.tools"] --> tool_precedence
        tool_precedence -->|Task tools override| final_tools["Final Tool List"]
    end
    
    subgraph "Processing Layer" 
        final_tools --> parse_tools_func["parse_tools()"]
        parse_tools_func --> validate_tools["Validate BaseTool instances"]
        validate_tools --> to_structured["Convert to CrewStructuredTool"]
        to_structured --> tool_list["List[CrewStructuredTool]"]
    end
    
    subgraph "Execution Context"
        tool_list --> agent_execution["Agent Execution Context"]
        agent_execution --> llm_integration["LLM Tool Descriptions"]
        agent_execution --> tools_handler_instance["ToolsHandler Instance"]
        tools_handler_instance --> cache_handler["CacheHandler Integration"]
    end
    
    subgraph "Memory Integration"
        tools_handler_instance --> memory_save["Memory Save Operations"]
        memory_save --> short_term["Short-term Memory"]
        memory_save --> long_term["Long-term Memory"] 
        memory_save --> external_mem["External Memory"]
    end
```

Sources: [src/crewai/utilities/agent_utils.py:29-39](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/utilities/agent_utils.py#L29-L39), [tests/test_task.py:22-73](https://github.com/crewAIInc/crewAI/blob/81bd81e5/tests/test_task.py#L22-L73), [src/crewai/agents/agent_builder/base_agent_executor_mixin.py:28-71](https://github.com/crewAIInc/crewAI/blob/81bd81e5/src/crewai/agents/agent_builder/base_agent_executor_mixin.py#L28-L71)

### LLM Tool Description Format

Tools are presented to LLMs through formatted descriptions generated by `render_text_description_and_args()` in [src/crewai/utilities/agent_utils.py:47-61]().

The format includes:
- Tool name and description from `BaseTool.description`
- Argument schema with types and descriptions
- Usage instructions and constraints

**Example Tool Description Pattern**:
```
Tool Name: tool_name
Tool Arguments: {'param': {'description': 'Parameter description', 'type': 'str'}}
Tool Description: What this tool does and when to use it
```

### Error Handling and Recovery

The system includes comprehensive error handling for tool execution failures:

**Parser Error Recovery** in [src/crewai/utilities/agent_utils.py:247-282]():
- `OutputParserException` handling with retry logic
- JSON repair for malformed tool inputs
- Context length management with summarization

**Execution Error Handling** in [src/crewai/utilities/agent_utils.py:225-246]():
- Unknown error logging and user notification  
- LLM context length exceeded detection and handling
- Graceful degradation for tool failures